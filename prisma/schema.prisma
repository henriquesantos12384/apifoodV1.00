// --- CONFIGURAÇÕES INICIAIS ---

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ======================================================
// ENUMS
// ======================================================

enum OrderType {
  SALAO
  DELIVERY
  RETIRADA
}

enum OrderStatus {
  PENDENTE
  EM_PREPARO
  PRONTO
  PRONTO_PARA_ENTREGA
  SAIU_PARA_ENTREGA
  ENTREGUE
  FINALIZADO
  CANCELADO
}

enum PaymentMethod {
  DINHEIRO
  PIX
  CARTAO_CREDITO
  CARTAO_DEBITO
  VALE_REFEICAO
}

enum CashRegisterStatus {
  OPEN
  CLOSED
}

// --- 1. CONTROLE DE ACESSO (RBAC) ---

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique // Ex: 'admin', 'garcom', 'cozinha'
  description String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy   String?  @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  // Relations
  users   User[] @relation("UserRole")
  creator User?  @relation("RoleCreator", fields: [createdBy], references: [id])
  updater User?  @relation("RoleUpdater", fields: [updatedBy], references: [id])

  @@map("roles")
}

// --- 2. MULTI-TENANCY (EMPRESA) ---

model Company {
  id          String   @id @default(uuid()) @db.Uuid
  status      String
  nameFantasy String   @map("name_fantasy")
  cnpj        String   @unique
  slug        String   @unique // Para URL amigável: app.com/pizzaria-x
  logoUrl     String?  @map("logo_url")
  address     String?
  description String?
  phone       String?
  color       String?  // Personalização da cor do app
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy   String?  @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  // Relations
  users   User[] @relation("UserCompany")
  creator User?  @relation("CompanyCreator", fields: [createdBy], references: [id])
  updater User?  @relation("CompanyUpdater", fields: [updatedBy], references: [id])

  // Catálogo e Operação
  categories       Category[]
  products         Product[]
  additionals      Additional[]
  pizzaSizes       PizzaSize[]
  pizzaFlavors     PizzaFlavor[]
  flavorSizePrices FlavorSizePrice[]
  pizzaBorders     PizzaBorder[]
  borderSizePrices BorderSizePrice[]
  promotions       Promotion[]
  
  // Novas Relações (Mesas e Pedidos)
  tables           RestaurantTable[]
  orders           Order[]
  carts            Cart[]
  orderItems       OrderItem[]
  orderPizzas      OrderPizza[]
  customers        Customer[]
  customerAddresses CustomerAddress[]
  deliveryAreas    DeliveryArea[]
  cashRegisters    CashRegister[]
  payments         Payment[]
  printers         Printer[]

  @@map("companies")
}

// --- 3. USUÁRIOS (DONOS, FUNCIONÁRIOS E CLIENTES) ---

model User {
  id           String   @id @default(uuid()) @db.Uuid
  fullName     String   @map("full_name")
  email        String   @unique
  phone        String?
  passwordHash String   @map("password_hash")
  roleId       String?  @map("role_id") @db.Uuid
  companyId    String?  @map("company_id") @db.Uuid
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy    String?  @map("created_by") @db.Uuid
  updatedBy    String?  @map("updated_by") @db.Uuid

  // Relations
  role    Role?    @relation("UserRole", fields: [roleId], references: [id])
  company Company? @relation("UserCompany", fields: [companyId], references: [id])

  // Auditoria (Quem criou quem)
  creator User? @relation("UserCreator", fields: [createdBy], references: [id])
  updater User? @relation("UserUpdater", fields: [updatedBy], references: [id])

  // Reverse Relations (Auditoria)
  createdRoles       Role[]    @relation("RoleCreator")
  updatedRoles       Role[]    @relation("RoleUpdater")
  createdCompanies   Company[] @relation("CompanyCreator")
  updatedCompanies   Company[] @relation("CompanyUpdater")
  createdUsers       User[]    @relation("UserCreator")
  updatedUsers       User[]    @relation("UserUpdater")

  // Orders served
  ordersServed       Order[]   @relation("OrderWaiter")
  ordersDelivered    Order[]   @relation("OrderDriver")

  // Reverse Relations (Catálogo)
  createdCategories      Category[]        @relation("CategoryCreator")
  updatedCategories      Category[]        @relation("CategoryUpdater")
  createdProducts        Product[]         @relation("ProductCreator")
  updatedProducts        Product[]         @relation("ProductUpdater")
  createdAdditionals     Additional[]      @relation("AdditionalCreator")
  updatedAdditionals     Additional[]      @relation("AdditionalUpdater")
  
  // Relations Pizza
  createdPizzaFlavors    PizzaFlavor[]     @relation("PizzaFlavorCreator")
  updatedPizzaFlavors    PizzaFlavor[]     @relation("PizzaFlavorUpdater")
  createdPizzaSizes      PizzaSize[]       @relation("PizzaSizeCreator")
  updatedPizzaSizes      PizzaSize[]       @relation("PizzaSizeUpdater")
  createdPizzaBorders    PizzaBorder[]     @relation("PizzaBorderCreator")
  updatedPizzaBorders    PizzaBorder[]     @relation("PizzaBorderUpdater")
  createdPromotions      Promotion[]       @relation("PromotionCreator")
  updatedPromotions      Promotion[]       @relation("PromotionUpdater")

  paymentsReceived Payment[]

  @@map("users")
}

//
// ======================================================
// CLIENTES
// ======================================================
// Cliente é reutilizável
// Telefone identifica, não email
//
model Customer {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  name  String
  phone String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  company Company @relation(fields: [companyId], references: [id])
  orders  Order[]
  addresses CustomerAddress[]

  @@unique([companyId, phone])
  @@map("customers")
}

model CustomerAddress {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  customerId  String   @map("customer_id") @db.Uuid
  street      String
  number      String
  complement  String?
  neighborhood String
  reference   String?
  latitude    Float? // User requested: latitude
  longitude   Float? // User requested: longitude
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  company  Company  @relation(fields: [companyId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_addresses")
}

//
// ======================================================
// ÁREA DE ENTREGA
// ======================================================
// Define onde a empresa entrega
//
model DeliveryArea {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  neighborhood String // Bairro
  deliveryFee  Decimal @map("delivery_fee") @db.Decimal(10,2)
  isActive     Boolean @default(true) @map("is_active")

  company Company @relation(fields: [companyId], references: [id])
  orders  Order[]

  @@unique([companyId, neighborhood])
  @@map("delivery_areas")
}

// --- 5. CARDÁPIO SIMPLES (PRODUTOS) ---

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  companyId    String   @map("company_id") @db.Uuid
  name         String
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy    String?  @map("created_by") @db.Uuid
  updatedBy    String?  @map("updated_by") @db.Uuid

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User?   @relation("CategoryCreator", fields: [createdBy], references: [id])
  updater User?   @relation("CategoryUpdater", fields: [updatedBy], references: [id])

  products    Product[]
  additionals Additional[]
  pizzaFlavors PizzaFlavor[]
  @@map("categories")
}

model Product {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  categoryId  String   @map("category_id") @db.Uuid
  name        String
  description String?
  imageUrl    String?  @map("image_url")
  price       Decimal  @db.Decimal(10, 2) // Preço base do produto
  isMenu      Boolean  @default(true) @map("is_menu")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy   String?  @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])
  creator  User?    @relation("ProductCreator", fields: [createdBy], references: [id])
  updater  User?    @relation("ProductUpdater", fields: [updatedBy], references: [id])
  
  // Relacionamento com itens do pedido
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@map("products")
}

model Additional {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  categoryId String?  @map("category_id") @db.Uuid
  name       String
  price      Decimal  @db.Decimal(10, 2)
  imageUrl   String?  @map("image_url")
  isMenu     Boolean  @default(true) @map("is_menu")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy  String?  @map("created_by") @db.Uuid
  updatedBy  String?  @map("updated_by") @db.Uuid

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])
  creator  User?     @relation("AdditionalCreator", fields: [createdBy], references: [id])
  updater  User?     @relation("AdditionalUpdater", fields: [updatedBy], references: [id])

  @@map("additionals")
}

// --- 6. ENGENHARIA DA PIZZA (COMPLEXA) ---

model PizzaSize {
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  name       String   // Pequena, Média, Gigante
  slices     Int      // 4, 8, 12 fatias
  maxFlavors Int      @map("max_flavors") // Pode dividir em até quantos sabores?
  diameterCm Int?     @map("diameter_cm")
  serves     Int?     // Serve quantas pessoas?
  imageUrl   String?  @map("image_url")
  isMenu     Boolean  @default(true) @map("is_menu")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy  String?  @map("created_by") @db.Uuid
  updatedBy  String?  @map("updated_by") @db.Uuid

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User?   @relation("PizzaSizeCreator", fields: [createdBy], references: [id])
  updater User?   @relation("PizzaSizeUpdater", fields: [updatedBy], references: [id])

  flavorPrices FlavorSizePrice[]
  borderPrices BorderSizePrice[]

  orderPizzas      OrderPizza[] // Relations
  cartPizzas       CartPizza[]
  @@map("pizza_sizes")
}

model PizzaFlavor {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  categoryId  String?  @map("category_id") @db.Uuid
  type        String?  // Salgada, Doce
  imageUrl    String?  @map("image_url")
  name        String
  description String?
  isMenu      Boolean  @default(true) @map("is_menu")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy   String?  @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])
  creator User?   @relation("PizzaFlavorCreator", fields: [createdBy], references: [id])
  updater User?   @relation("PizzaFlavorUpdater", fields: [updatedBy], references: [id])

  sizePrices       FlavorSizePrice[]
  orderPizzaFlavors OrderPizzaFlavor[]
  cartPizzaFlavors CartPizzaFlavor[]

  @@map("pizza_flavors")
}

// TABELA DE PREÇO MATRIX (SABOR X TAMANHO)
// Aqui mora a lógica: "Quanto custa Calabresa na Grande?"
model FlavorSizePrice {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  flavorId  String   @map("flavor_id") @db.Uuid
  sizeId    String   @map("size_id") @db.Uuid
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  company Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  flavor  PizzaFlavor @relation(fields: [flavorId], references: [id], onDelete: Cascade)
  size    PizzaSize   @relation(fields: [sizeId], references: [id], onDelete: Cascade)

  @@unique([flavorId, sizeId]) // Garante que não tenha preço duplicado para o mesmo par
  @@map("flavor_size_prices")
}

model PizzaBorder {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  name      String
  isMenu    Boolean  @default(true) @map("is_menu")
  isDefault Boolean  @default(false) @map("is_default")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy String?  @map("created_by") @db.Uuid
  updatedBy String?  @map("updated_by") @db.Uuid

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User?   @relation("PizzaBorderCreator", fields: [createdBy], references: [id])
  updater User?   @relation("PizzaBorderUpdater", fields: [updatedBy], references: [id])

  sizePrices  BorderSizePrice[]
  orderPizzas OrderPizza[]
  cartPizzas  CartPizza[]

  @@map("pizza_borders")
}

model BorderSizePrice {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  borderId  String   @map("border_id") @db.Uuid
  sizeId    String   @map("size_id") @db.Uuid
  price     Decimal  @db.Decimal(10, 2)
  isMenu    Boolean  @default(true) @map("is_menu")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  company Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  border  PizzaBorder @relation(fields: [borderId], references: [id], onDelete: Cascade)
  size    PizzaSize   @relation(fields: [sizeId], references: [id], onDelete: Cascade)

  @@unique([borderId, sizeId])
  @@map("border_size_prices")
}

model Promotion {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy   String?  @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User?   @relation("PromotionCreator", fields: [createdBy], references: [id])
  updater User?   @relation("PromotionUpdater", fields: [updatedBy], references: [id])

  @@map("promotions")
}

//
// ======================================================
// PEDIDOS
// ======================================================
// Pedido não guarda lógica de entrega
// Só referencia cliente e área
//
model Order {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  orderType OrderType @map("order_type")
  status    OrderStatus @default(PENDENTE)

  tableId  String? @map("table_id") @db.Uuid
  customerId String? @map("customer_id") @db.Uuid
  deliveryAreaId String? @map("delivery_area_id") @db.Uuid
  waiterId       String? @map("waiter_id") @db.Uuid
  driverId       String? @map("driver_id") @db.Uuid

  deliveryAddress String? @map("delivery_address")
  deliveryLatitude  Float? @map("delivery_latitude")
  deliveryLongitude Float? @map("delivery_longitude")

  totalProducts Decimal @default(0) @map("total_products") @db.Decimal(10,2)
  deliveryFee   Decimal @default(0) @map("delivery_fee")   @db.Decimal(10,2)
  discount      Decimal @default(0)                         @db.Decimal(10,2)
  totalFinal    Decimal @default(0) @map("total_final")     @db.Decimal(10,2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  company Company @relation(fields: [companyId], references: [id])
  table   RestaurantTable? @relation(fields: [tableId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  deliveryArea DeliveryArea? @relation(fields: [deliveryAreaId], references: [id])
  driver       User?         @relation("OrderDriver", fields: [driverId], references: [id])
  waiter       User?         @relation("OrderWaiter", fields: [waiterId], references: [id])

  items    OrderItem[]
  pizzas   OrderPizza[]
  payments Payment[]
  trackingSession TrackingSession?

  @@index([companyId, status])
  @@map("orders")
}

model TrackingSession {
  id String @id @default(uuid()) @db.Uuid
  orderId String @unique @map("order_id") @db.Uuid
  token String @unique
  
  currentLatitude Float? @map("current_latitude")
  currentLongitude Float? @map("current_longitude")
  lastUpdate DateTime? @map("last_update")

  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  
  order Order @relation(fields: [orderId], references: [id])
  
  @@map("tracking_sessions")
}

//
// ======================================================
// ITENS DO PEDIDO
// ======================================================
//
model OrderItem {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  orderId   String   @map("order_id")   @db.Uuid
  productId String   @map("product_id") @db.Uuid

  quantity   Int
  unitPrice  Decimal @map("unit_price")  @db.Decimal(10,2)
  totalPrice Decimal @map("total_price") @db.Decimal(10,2)
  notes      String?
  
  createdAt  DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

//
// ======================================================
// PIZZAS DO PEDIDO
// ======================================================
//
model OrderPizza {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  orderId   String   @map("order_id")   @db.Uuid
  
  sizeId    String?  @map("size_id") @db.Uuid
  borderId  String?  @map("border_id") @db.Uuid

  quantity   Int
  unitPrice  Decimal @map("unit_price")  @db.Decimal(10,2)
  totalPrice Decimal @map("total_price") @db.Decimal(10,2)
  observation String?
  
  createdAt  DateTime @default(now()) @map("created_at")

  company Company      @relation(fields: [companyId], references: [id])
  order   Order        @relation(fields: [orderId], references: [id])
  size    PizzaSize?   @relation(fields: [sizeId], references: [id])
  border  PizzaBorder? @relation(fields: [borderId], references: [id])

  flavors OrderPizzaFlavor[]

  @@map("order_pizzas")
}

model OrderPizzaFlavor {
  id           String   @id @default(uuid()) @db.Uuid
  orderPizzaId String   @map("order_pizza_id") @db.Uuid
  flavorId     String   @map("flavor_id") @db.Uuid

  orderPizza OrderPizza  @relation(fields: [orderPizzaId], references: [id], onDelete: Cascade)
  flavor     PizzaFlavor @relation(fields: [flavorId], references: [id])

  @@map("order_pizza_flavors")
}

//
// ======================================================
// MESAS
// ======================================================
//
model RestaurantTable {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  tableNumber Int @map("table_number")
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id])
  orders  Order[]
  cart    Cart?  // Relation to the active cart

  @@unique([companyId, tableNumber])
  @@map("restaurant_tables")
}

//
// ======================================================
// CAIXA (PDV)
// ======================================================
//
model CashRegister {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  status CashRegisterStatus @default(OPEN)

  openedAt DateTime
  closedAt DateTime?

  openingAmount Decimal @db.Decimal(10,2)
  closingAmount Decimal? @db.Decimal(10,2)

  openedBy String @db.Uuid
  closedBy String? @db.Uuid

  company Company @relation(fields: [companyId], references: [id])
  payments Payment[]

  @@map("cash_registers")
}

//
// ======================================================
// PAGAMENTOS
// ======================================================
//
model Payment {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  orderId   String   @map("order_id")   @db.Uuid

  cashRegisterId String? @map("cash_register_id") @db.Uuid

  method PaymentMethod
  amount Decimal @db.Decimal(10,2)

  paidAt DateTime @default(now())
  receivedBy String @db.Uuid

  company Company @relation(fields: [companyId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])
  cashRegister CashRegister? @relation(fields: [cashRegisterId], references: [id])
  user    User    @relation(fields: [receivedBy], references: [id])

  @@map("payments")
}

// --- 8. PERIFÉRICOS (IMPRESSORAS) ---

model Printer {
  id          String        @id @default(uuid()) @db.Uuid
  companyId   String        @map("company_id") @db.Uuid
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String        // Nome amigável (ex: "Cozinha Térmica")
  systemName  String        @map("system_name") // Nome no Windows (ex: "EPSON_TM_T20")
  
  type        PrinterType   @default(KITCHEN)
  format      PrinterFormat @default(THERMAL_80mm)
  
  isActive    Boolean       @default(true) @map("is_active")
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("printers")
}

enum PrinterType {
  KITCHEN
  CASHIER
  REPORT
  OTHER
}

enum PrinterFormat {
  THERMAL_80mm
  THERMAL_58mm
  A4
}

//
// ======================================================
// CARRINHO (PERSISTÊNCIA)
// ======================================================
//
model Cart {
  id        String   @id @default(uuid()) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  tableId   String?  @unique @map("table_id") @db.Uuid // 1 Cart per Table
  waiterId  String?  @map("waiter_id") @db.Uuid
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  company Company @relation(fields: [companyId], references: [id])
  table   RestaurantTable? @relation(fields: [tableId], references: [id])

  items    CartItem[]
  pizzas   CartPizza[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid()) @db.Uuid
  cartId    String   @map("cart_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  quantity  Int
  notes     String?
  
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model CartPizza {
  id        String   @id @default(uuid()) @db.Uuid
  cartId    String   @map("cart_id") @db.Uuid
  sizeId    String   @map("size_id") @db.Uuid
  borderId  String?  @map("border_id") @db.Uuid
  quantity  Int
  observation String?
  unitPrice  Decimal? @map("unit_price")  @db.Decimal(10,2) // Snapshot price

  cart    Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  size    PizzaSize   @relation(fields: [sizeId], references: [id])
  border  PizzaBorder? @relation(fields: [borderId], references: [id])
  
  flavors CartPizzaFlavor[]

  @@map("cart_pizzas")
}

model CartPizzaFlavor {
  id          String   @id @default(uuid()) @db.Uuid
  cartPizzaId String   @map("cart_pizza_id") @db.Uuid
  flavorId    String   @map("flavor_id") @db.Uuid

  cartPizza CartPizza @relation(fields: [cartPizzaId], references: [id], onDelete: Cascade)
  flavor    PizzaFlavor @relation(fields: [flavorId], references: [id])

  @@map("cart_pizza_flavors")
}
